services:
  # --- Tier 1: Frontend (Nginx) ---
  dashboard:
    image: nginx:alpine
    container_name: app-dashboard
    ports:
      - "8081:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html
    networks:
      - app-network
    depends_on:
      - backend

  # --- Tier 2: Backend (Node.js) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: app-backend
    ports:
      - "5000:5000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      # REMOVED the ./backend:/app mount to prevent host-path overriding
      - .:/host_root  # Mount project root here so scripts can find compose files
    environment:
      - DB_HOST_PRIMARY=primary-db
      - DB_HOST_REPLICA=replica-db
      - DB_USER=root
      - DB_PASSWORD=production_secure_password
      - DB_NAME=app_db
    networks:
      - app-network
    depends_on:
      - primary-db

  # --- Tier 3: Database (MySQL 8.0) ---
  primary-db:
    image: mysql:8.0
    container_name: primary-db
    command: --server-id=1 --log-bin=mysql-bin --binlog-format=ROW --gtid_mode=ON --enforce-gtid-consistency=ON --max-connections=500
    environment:
      - MYSQL_ROOT_PASSWORD=production_secure_password
      - MYSQL_DATABASE=app_db
    volumes:
      - ./db-config/init-primary.sql:/docker-entrypoint-initdb.d/init.sql
      - ./db-config/primary.cnf:/etc/mysql/conf.d/primary.cnf
    ports:
      - "3306:3306"
    networks:
      - app-network

  replica-db:
    image: mysql:8.0
    command: --log-bin=mysql-bin --read-only=1 --gtid_mode=ON --enforce-gtid-consistency=ON --max-connections=500
    environment:
      - MYSQL_ROOT_PASSWORD=production_secure_password
      - MYSQL_DATABASE=app_db
    volumes:
      - ./db-config/replica.cnf:/etc/mysql/conf.d/replica.cnf
    networks:
      - app-network
    depends_on:
      - primary-db

  # --- Load Testing (Locust) ---
  locust:
    image: locustio/locust
    container_name: locust-load-test
    ports:
      - "8089:8089"
    volumes:
      - ./locustfile.py:/home/locust/locustfile.py
    command: -f /home/locust/locustfile.py --host http://app-backend:5000
    networks:
      - app-network

  # --- Autoscaling Engine ---
  autoscale-engine:
    build:
      context: ./backend  # Reuse backend image as it has docker/compose tools
    container_name: autoscale-engine
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/host_root
    working_dir: /host_root
    command: ./autoscale_engine.sh
    depends_on:
      - primary-db
      - replica-db
    networks:
      - app-network

networks:
  app-network:
    driver: bridge