<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud-Ops Alpha | 3-Tier Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0f19; --card: #161b22; --text: #c9d1d9; --primary: #58a6ff; --accent: #7ee787; --warn: #d29922; --danger: #f85149; }
        body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#07101a 0%, #0b0f19 100%); color: var(--text); margin: 0; padding: 24px; }
        .container-custom { max-width: 1200px; margin: 0 auto; }
        .dashboard-header { display:flex; justify-content:space-between; align-items:center; gap:16px; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 18px; margin-bottom: 28px; }
        .brand { display:flex; align-items:center; gap:12px; }
        .brand h1 { margin:0; font-size:1.1rem; letter-spacing:0.6px; font-weight:800; color:#ffffff; }
        .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 18px; margin-bottom: 22px; }
        .stat-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:18px; border-radius:12px; border: 1px solid rgba(255,255,255,0.04); text-align:center; box-shadow: 0 6px 18px rgba(2,6,23,0.6); }
        .stat-val { font-size: 2.1rem; font-weight: 800; color: var(--primary); display:block; }
        .stat-label { font-size: 0.78rem; text-transform: uppercase; color: #94a3b8; letter-spacing: 1px; }
        .main-layout { display:grid; grid-template-columns: 2fr 1fr; gap:18px; }
        .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:12px; border:1px solid rgba(255,255,255,0.03); padding:18px; box-shadow: 0 8px 20px rgba(2,6,23,0.6); }
        table { width:100%; border-collapse: collapse; font-size:0.9rem; }
        th { text-align:left; color:var(--primary); padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.04); }
        td { padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.02); color:#c9d1d9; }
        .badge { padding:5px 10px; border-radius:999px; font-size:0.75rem; font-weight:700; }
        .badge-read { background: rgba(88,166,255,0.12); color: var(--primary); }
        .badge-write { background: rgba(126,231,135,0.12); color: var(--accent); }
        .ctrl-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding:10px 14px; border-radius:8px; cursor:pointer; transition:all .18s ease; font-weight:700; }
        .ctrl-btn:hover { background: var(--primary); color: #07101a; transform: translateY(-2px); }
        .status-msg { margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:0.85rem; }
        .small-muted { color:#94a3b8; font-size:0.85rem; }
        @media (max-width: 900px) { .grid { grid-template-columns: repeat(2,1fr); } .main-layout { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } .stat-val { font-size:1.6rem; } .brand h1 { font-size:0.95rem; } }
    </style>
</head>
<body>
        <div class="container-custom">
            <div class="dashboard-header">
                <div class="brand">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#071827"/><path d="M6 12h12M6 8h12M6 16h12" stroke="#58a6ff" stroke-width="1.4" stroke-linecap="round"/></svg>
                    <h1>Cloud-Ops — 3‑Tier Monitor</h1>
                </div>
                <div>
                    <div id="status-indicator" style="color: var(--accent); font-weight:700">● SYSTEM ONLINE</div>
                    <div class="small-muted" style="text-align:right">Updated: <span id="updated-ts">—</span></div>
                </div>
            </div>

            <div class="grid">
        <div class="stat-card"><span class="stat-label">Active Replicas</span><span class="stat-val" id="replica-count">2</span></div>
        <div class="stat-card"><span class="stat-label">Avg Latency</span><span class="stat-val" id="latency">--</span></div>
        <div class="stat-card"><span class="stat-label">Total Logs</span><span class="stat-val" id="total-req">0</span></div>
        <div class="stat-card"><span class="stat-label">Cluster Load</span><span class="stat-val" id="load-pct">0%</span></div>
    </div>
        <div class="main-layout">
        <div class="panel">
            <h2>Live Distribution Chart</h2>
            <canvas id="distributionChart" height="120"></canvas>
            <h2 style="margin-top:30px">Request History</h2>
            <table>
                <thead><tr><th>ID</th><th>NODE</th><th>TYPE</th><th>TIME</th></tr></thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>

        <div class="side-controls">
            <div class="panel" style="border-left: 4px solid var(--warn);">
                <h2>Manual Scaling</h2>
                <p style="font-size: 0.8rem; color: #8b949e;">Direct Docker Socket Control</p>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button onclick="manualScale(2)" class="ctrl-btn">Scale → 2</button>
                    <button onclick="manualScale(3)" class="ctrl-btn">Scale → 3</button>
                    <button onclick="manualScale(5)" class="ctrl-btn">Scale → 5</button>
                </div>
                <div id="scale-status" class="status-msg"></div>
            </div>
        </div>
    </div>
    </div>

    <script>
        const ctx = document.getElementById('distributionChart').getContext('2d');
        const distributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Primary', 'Replica-1', 'Replica-2', 'Replica-3', 'Replica-4', 'Replica-5'],
                datasets: [{ label: 'Hits', data: [0, 0, 0, 0, 0, 0], backgroundColor: '#58a6ff' }]
            },
            options: { scales: { y: { beginAtZero: true, grid: { color: '#30363d' } } }, plugins: { legend: { display: false } } }
        });

        async function manualScale(count) {
            const status = document.getElementById('scale-status');
            status.style.color = 'var(--warn)';
            status.innerText = "⏳ Requesting scale to " + count + "...";
            try {
                const res = await fetch('http://localhost:5000/api/scale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count })
                });
                const result = await res.json();
                status.style.color = 'var(--accent)';
                status.innerText = "✅ " + result.message;
            } catch (e) {
                status.style.color = 'var(--danger)';
                status.innerText = "❌ Error: " + e.message;
            }
        }

        async function refresh() {
            const start = Date.now();
            try {
                const [dRes, lRes] = await Promise.all([
                    fetch('http://localhost:5000/api/data'),
                    fetch('http://localhost:5000/api/logs')
                ]);
                const data = await dRes.json();
                const logs = await lRes.json();
                
                document.getElementById('latency').innerText = (Date.now() - start) + 'ms';
                document.getElementById('replica-count').innerText = data.active_nodes;
                document.getElementById('total-req').innerText = logs.length;

                const counts = [0,0,0,0,0,0];
                logs.forEach(l => {
                    if(l.node_used.includes('primary')) counts[0]++;
                    else if(l.node_used.includes('-1')) counts[1]++;
                    else if(l.node_used.includes('-2')) counts[2]++;
                    else if(l.node_used.includes('-3')) counts[3]++;
                    else if(l.node_used.includes('-4')) counts[4]++;
                    else if(l.node_used.includes('-5')) counts[5]++;
                });
                distributionChart.data.datasets[0].data = counts;
                distributionChart.update();

                document.getElementById('logBody').innerHTML = logs.slice(0, 10).map(l => `
                    <tr><td>#${l.id}</td><td>${l.node_used}</td>
                    <td><span class="badge ${l.request_type === 'READ' ? 'badge-read' : 'badge-write'}">${l.request_type}</span></td>
                    <td>${new Date(l.timestamp).toLocaleTimeString()}</td></tr>
                `).join('');
            } catch (e) { document.getElementById('status-indicator').innerText = '● SYSTEM OFFLINE'; }
        }
        setInterval(refresh, 2000);
    </script>
</body>
</html>